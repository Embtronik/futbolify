server {
  listen 80;
  server_name _;
  #listen 443 ssl http2;
  #server_name futbolify.co www.futbolify.co;

  # =========================
  # SSL (Let's Encrypt)
  # =========================
  #ssl_certificate     /etc/letsencrypt/live/futbolify.co/fullchain.pem;
  #ssl_certificate_key /etc/letsencrypt/live/futbolify.co/privkey.pem;

  # (Opcional) HSTS (actívalo cuando todo esté estable)
  # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

  # =========================
  # OAUTH2 - FRONT route (Angular)
  # =========================
  # Esta ruta es del FRONT: /oauth2/redirect?token=...
  location = /oauth2/redirect {
    proxy_pass http://front-end:80;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  # =========================
  # OAUTH2 - Spring Security (AUTH SERVICE)
  # =========================

  # Inicio OAuth (Spring Security)
  location ^~ /oauth2/authorization/ {
    proxy_pass http://auth-service:8080;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port 443;
  }

  # Callback OAuth (clásico Spring Security)
  location ^~ /login/oauth2/ {
    proxy_pass http://auth-service:8080;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port 443;
  }

  # Callback OAuth (nuevo, por si tu app lo usa)
  location ^~ /oauth2/ {
    proxy_pass http://auth-service:8080;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port 443;
  }

  # =========================
  # AUTH API (si la usas)
  # =========================
  location ^~ /api/v1/ {
    proxy_pass http://auth-service:8080;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port 443;
  }

  # =========================
  # API-Football (proxy a api-sports)
  # =========================
  location ^~ /api/football/ {
    proxy_pass https://v3.football.api-sports.io/;
    proxy_http_version 1.1;
    proxy_ssl_server_name on;

    proxy_set_header Host v3.football.api-sports.io;
    proxy_set_header x-apisports-key c4029806cbd1a1a4cdb25107398464d4;

    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
  }

  # =========================
  # APIs internas por rutas
  # =========================

  # (Opcional) si tu front llama /api/auth/ en vez de /api/v1/
  location ^~ /api/auth/ {
    proxy_pass http://auth-service:8080/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  location ^~ /api/notif/ {
    proxy_pass http://notificacion-service:8081/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  # ✅ Evita el 301 raro cuando el front llame /api/teams (sin slash)
  # TEAMS: si llega sin slash, lo reescribe internamente (NO redirect)
  location = /api/teams {
    rewrite ^ /api/teams/ break;
    proxy_pass http://teams-service:8082;
    proxy_http_version 1.1;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port 443;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  location ^~ /api/teams/ {
    proxy_pass http://teams-service:8082;
    proxy_http_version 1.1;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port 443;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  # MATCHES
  location = /api/matches {
    rewrite ^ /api/matches/ break;
    proxy_pass http://teams-service:8082;
    proxy_http_version 1.1;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  location ^~ /api/matches/ {
    proxy_pass http://teams-service:8082;
    proxy_http_version 1.1;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  # POLLAS
  location = /api/pollas {
    rewrite ^ /api/pollas/ break;
    proxy_pass http://teams-service:8082;
    proxy_http_version 1.1;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  location ^~ /api/pollas/ {
    proxy_pass http://teams-service:8082;
    proxy_http_version 1.1;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  # STATS
  location = /api/stats {
    rewrite ^ /api/stats/ break;
    proxy_pass http://teams-service:8082;
    proxy_http_version 1.1;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  location ^~ /api/stats/ {
    proxy_pass http://teams-service:8082;
    proxy_http_version 1.1;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  # =========================
  # FRONT (Angular)
  # =========================
  location / {
    proxy_pass http://front-end:80;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
  }
}
