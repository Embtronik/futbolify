server {
  listen 80;
  server_name _;

  # =========================================================
  # HEADERS GLOBALES (CLAVE para ngrok -> nginx:80 -> spring)
  # Fuerza a que Spring entienda que "afuera" es HTTPS
  # =========================================================
  proxy_http_version 1.1;

  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

  # ngrok es HTTPS hacia el mundo externo
  proxy_set_header X-Forwarded-Proto https;
  proxy_set_header X-Forwarded-Port 443;
  proxy_set_header X-Forwarded-Host $host;

  # =========================================================
  # DEBUG TEMPORAL: revisa qué ve nginx desde ngrok
  # Abre: https://TU_NGROK/_debug_headers
  # =========================================================
  location = /_debug_headers {
    default_type text/plain;
    return 200
"host=$host
scheme=$scheme
x-forwarded-proto=$http_x_forwarded_proto
x-forwarded-host=$http_x_forwarded_host
x-forwarded-port=$http_x_forwarded_port
";
  }

  # =========================
  # OAUTH2 - FRONT route (Angular)
  # =========================
  # Ruta del FRONT: /oauth2/redirect?token=...
  location = /oauth2/redirect {
    proxy_pass http://front-end:80;
  }

  # =========================
  # OAUTH2 - Spring Security (AUTH SERVICE)
  # =========================

  # Inicio OAuth: /oauth2/authorization/google
  location ^~ /oauth2/authorization/ {
    proxy_pass http://auth-service:8080;
  }

  # Callback OAuth: /login/oauth2/code/google
  location ^~ /login/oauth2/ {
    proxy_pass http://auth-service:8080;
  }

  # API auth
  location ^~ /api/v1/ {
    proxy_pass http://auth-service:8080;
  }

  # (Opcional) si tu front llama /api/auth/ en vez de /api/v1/
  location ^~ /api/auth/ {
    proxy_pass http://auth-service:8080;
  }

  # =========================
  # NOTIFICACIONES
  # =========================
  location ^~ /api/notif/ {
    proxy_pass http://notificacion-service:8081;
  }

  # =========================
  # TEAMS (y rutas que atiende teams-service)
  # =========================
  location = /api/teams {
    return 308 /api/teams/;
  }
  location ^~ /api/teams/ {
    proxy_pass http://teams-service:8082;
    proxy_set_header Authorization $http_authorization;
  }

  location = /api/matches {
    return 308 /api/matches/;
  }
  location ^~ /api/matches/ {
    proxy_pass http://teams-service:8082;
    proxy_set_header Authorization $http_authorization;
  }

  location = /api/pollas {
    return 308 /api/pollas/;
  }
  location ^~ /api/pollas/ {
    proxy_pass http://teams-service:8082;
    proxy_set_header Authorization $http_authorization;
  }

  location = /api/stats {
    return 308 /api/stats/;
  }
  location ^~ /api/stats/ {
    proxy_pass http://teams-service:8082;
    proxy_set_header Authorization $http_authorization;
  }

  # =========================
  # PAYMENT
  # =========================
  location = /api/payment {
    return 308 /api/payment/;
  }
  location ^~ /api/payment/ {
    proxy_pass http://payment-service:8083;
    proxy_set_header Authorization $http_authorization;
  }

  # =========================
  # API-Football (proxy a api-sports)
  # =========================
  location ^~ /api/football/ {
    proxy_pass https://v3.football.api-sports.io/;
    proxy_ssl_server_name on;

    proxy_set_header Host v3.football.api-sports.io;
    proxy_set_header x-apisports-key c4029806cbd1a1a4cdb25107398464d4;

    # (estos ya están globales, pero no estorba)
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port 443;
  }

  # =========================
  # FRONT (Angular)
  # =========================
  location / {
    proxy_pass http://front-end:80;
  }
}
