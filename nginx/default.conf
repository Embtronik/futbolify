server {
  listen 80;
  server_name _;

  # =========================
  # OAUTH2 - FRONT route (Angular)
  # =========================
  # Esta ruta es del FRONT: /oauth2/redirect?token=...
  location = /oauth2/redirect {
    proxy_pass http://front-end:80;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;

    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
  }

  # =========================
  # OAUTH2 - Spring Security (AUTH SERVICE)
  # =========================

  # Inicio OAuth: /oauth2/authorization/google
  location ^~ /oauth2/authorization/ {
    proxy_pass http://auth-service:8080;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;

    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
  }

  # Callback de OAuth: /login/oauth2/code/google
  location ^~ /login/oauth2/ {
    proxy_pass http://auth-service:8080;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;

    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
  }

  # API auth (tu backend)
  location ^~ /api/v1/ {
    proxy_pass http://auth-service:8080;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;

    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
  }

  # (Opcional) si tu front llama /api/auth/ en vez de /api/v1/
  location ^~ /api/auth/ {
    proxy_pass http://auth-service:8080;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;

    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
  }

  # =========================
  # NOTIFICACIONES
  # =========================
  location ^~ /api/notif/ {
    proxy_pass http://notificacion-service:8081;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;

    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
  }

  # =========================
  # TEAMS (y rutas que atiende teams-service)
  # =========================
  location = /api/teams {
    return 308 /api/teams/;
  }
  location ^~ /api/teams/ {
    proxy_pass http://teams-service:8082;
    proxy_http_version 1.1;

    proxy_set_header Authorization $http_authorization;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;

    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
  }

  location = /api/matches {
    return 308 /api/matches/;
  }
  location ^~ /api/matches/ {
    proxy_pass http://teams-service:8082;
    proxy_http_version 1.1;

    proxy_set_header Authorization $http_authorization;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;

    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
  }

  location = /api/pollas {
    return 308 /api/pollas/;
  }
  location ^~ /api/pollas/ {
    proxy_pass http://teams-service:8082;
    proxy_http_version 1.1;

    proxy_set_header Authorization $http_authorization;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;

    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
  }

  location = /api/stats {
    return 308 /api/stats/;
  }
  location ^~ /api/stats/ {
    proxy_pass http://teams-service:8082;
    proxy_http_version 1.1;

    proxy_set_header Authorization $http_authorization;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;

    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
  }

  # =========================
  # PAYMENT
  # =========================
  location = /api/payment {
    return 308 /api/payment/;
  }
  location ^~ /api/payment/ {
    proxy_pass http://payment-service:8083;
    proxy_http_version 1.1;

    proxy_set_header Authorization $http_authorization;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;

    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
  }

  # =========================
  # API-Football (proxy a api-sports)
  # =========================
  location ^~ /api/football/ {
    proxy_pass https://v3.football.api-sports.io/;
    proxy_http_version 1.1;
    proxy_ssl_server_name on;

    proxy_set_header Host v3.football.api-sports.io;
    proxy_set_header x-apisports-key c4029806cbd1a1a4cdb25107398464d4;

    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # =========================
  # FRONT (Angular)
  # =========================
  location / {
    proxy_pass http://front-end:80;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;

    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
  }
}
